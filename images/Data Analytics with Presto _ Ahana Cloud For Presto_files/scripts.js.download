document.addEventListener("DOMContentLoaded", function(){


  // CONTROLLER FOR MOBILE FOOTER NAVIGATION ACCORDION BEHAVIOR
  document.querySelectorAll('.widget-footer-area .widget_nav_menu').forEach(item => {
    item.addEventListener('click', ev => {
      target = ev.target;
      if (target.tagName != 'H3') return;
      console.log('click')
      toggleContent(target);
    })
  })

  function toggleContent(target) {
    var contentDiv = target.nextElementSibling;
    if (target.parentElement.className == "widget_nav_menu on") {
      target.parentElement.className = "widget_nav_menu";
      contentDiv.style.maxHeight = "0";
    } else {
      var contentHeight = contentDiv.firstElementChild.offsetHeight * 2.5;
      target.parentElement.className = "widget_nav_menu on";
      contentDiv.style.maxHeight = contentHeight + "px";
    }
  }

  document.getElementById('menu-toggle').addEventListener('click', ev => {
    console.log('click');
  });

  
}); // DOMContentLoaded

// SET EXPIRING LOCAL STORAGE
function setWithExpiry(key, value, ttl) {
  const now = new Date()

  // `item` is an object which contains the original value
  // as well as the time when it's supposed to expire
  const item = {
    value: value,
    expiry: now.getTime() + ttl,
  }
  localStorage.setItem(key, JSON.stringify(item))
}

function getWithExpiry(key) {
  const itemStr = localStorage.getItem(key)
  // if the item doesn't exist, return null
  if (!itemStr) {
    return null
  }
  const item = JSON.parse(itemStr)
  const now = new Date()
  // compare the expiry time of the item with the current time
  if (now.getTime() > item.expiry) {
    // If the item is expired, delete the item from storage
    // and return null
    localStorage.removeItem(key)
    return null
  }
  return item.value
}


jQuery(document).ready(function($) {

  // Callback for Google Analytics
  // window.dataLayer = window.dataLayer || [];
  window.dataLayer.push({ 'event': 'loaded_page' });
  $('body').on('click','.setup-video-series *',function(){
    console.log('video');
     window.dataLayer.push({ 'event': 'Click','category':'Videos','label':'setup video' });
  })

  // TOOLTIPS
  /*
   * Add .has-tooltip class to the object, then add data-tooltip="[tooltip content]" to the attributes. Basic HTML is allowed.
   */
  $('body').on('mouseenter', '.has-tooltip', function(e) {
    ttclass = 'tooltip'
    if ($(this).offset().left < 150) {
      ttclass = 'tooltip left'
    }
    if ($(this).offset().left > ($(window).width() - 150)) {
      ttclass = 'tooltip right'
    }

    $('<div/>', { class: ttclass }).html($(this).data('tooltip')).appendTo($(this));
  })
  $('body').on('mouseleave', '.has-tooltip', function(e) {
    $(this).empty();
  })



  // GTM TRIGGER 
  $('.nav-signup a, .getstarted a').on('click', function(e) {
    window.dataLayer.push({ 'event': 'clicked_get_started' });
  })


  // Create an observer instance
  var observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      var newNodes = mutation.addedNodes;
      // If there are new nodes added
      if (newNodes !== null) {
        var $nodes = $(newNodes);
        $nodes.each(function() {
          var $node = $(this);
          // check if new node added with class 'message'
          if ($node.hasClass("success-message")) {
            console.log("msg")
          }
        });
      }
    });
  });
  // Configuration of the observer:
  var config = {
    childList: true,
    attributes: true,
    subtree: true,
    characterData: true
  };
  var targetNode = document.body;
  observer.observe(targetNode, config);


  // IN THE PRESTO USERS GALLERY, OPEN CAPTIONS AS LINKS
  $('.presto-users-gallery .blocks-gallery-item figcaption').each(function() {
    let thisURL = this.innerHTML;
    let isLink = /^(<a href=)/;
    if (!isLink.test(thisURL)) {
      let pattern = /^((http|https):\/\/)/;
      if (!pattern.test(thisURL)) {
        thisURL = "https://" + thisURL;
      }
      let linkTag = `<a href="${thisURL}" target="_blank"></a>`;
      $(this).parent().append(linkTag);
    } else {
      $(this).children().empty().appendTo($(this).parent());
    }
  });


  // LOGO SLIDER HANDLER
  $('.wp-block-gallery.logo-slider').each(function() {
    let logos = $(this).find('.blocks-gallery-grid');
    $(logos).children().clone().appendTo($(logos));
    let ending = ($(logos).children().length * 100) - 0.5;
    let speed = ($(logos).children().length);
    $(logos).children().clone().appendTo($(logos));

    function resetLogos() {
      $(logos).css({ 'transition': 'transform 0s linear', 'transform': 'translate(0,0)' }).off('transitionend webkitTransitionEnd oTransitionEnd', resetLogos);
      setTimeout(startLogos);
    }

    function startLogos() {
      endPoint = '-' + ending + 'px';
      $(logos).css({ 'transition': 'transform ' + speed + 's linear', 'transform': 'translate(-' + ending + 'px,0)' }).on('transitionend webkitTransitionEnd oTransitionEnd', resetLogos);
    };
    startLogos();
  })


  // LAPTOP SLIDSHOW HANDLER
  $('.laptop-slideshow .laptop-screen').each(function() {
    let slides = $(this).children();
    let slideCount = slides.length;
    let curSlide = 0;
    let laptopSlideShow = setInterval(function() {
      if (curSlide < slideCount - 1) {
        curSlide++;
        slides[curSlide].className = 'show';
        slides[curSlide - 1].className = '';
      } else {
        slides[0].className = 'show';
        slides[curSlide].className = '';
        curSlide = 0;
      }
    }, 3000)
  })



  // open the signup typeform modal with email address
  function openTypeForm(tfid,email) {
    const tfsrc = "https://form.typeform.com/to/"+ tfid +"#email_address=" + email;
    let tfmodal = document.getElementById('typeform-modal');
    tfmodal.querySelector(".basic-modal-overclose").addEventListener('click', ev => {
      tfmodal.className = "basic-modal-overlay";
    })
    tfmodal.querySelector(".basic-modal-close").addEventListener('click', ev => {
      tfmodal.className = "basic-modal-overlay";
    })
    tfmodal.className = "basic-modal-overlay on"
    setTimeout(function() {
      tfmodal.className = "basic-modal-overlay on showing"
    }, 0.5)
    var tf = document.getElementById('typeform-full');
    tf.src = tfsrc;
    tf.style.display = "block";
    document.getElementById('tfscript').innerHTML = "<script type='text/javascript' src='https://embed.typeform.com/embed.js'><\/script>";
  }


// REALTIME VALIDATION AGAINST BLACKLIST FOR EMAIL FIELDS
  $('body').on('input','form.signup_ajax input[name=email],form.signup-email-step1 input[name=email],form.signup-full input[name=email], .company-email form input[type=email]', function(e){
    $(this).parent().find('.email_error').css("display","none");
    let em = $(this).val();
    if(isBlackListed(em)){
     $(this).val("");
     $(this).siblings('.email_error').html("Please use a valid <u>business</u> email address.").css("display","block");
     if ($(this).hasClass("kb-email-field")){
      $(this).after('<div style="font-size: 0.9rem;font-style:italic;color:red;">Please use a valid company email address</div>');
     }
    }
  });

  // signup email preform validator and handler
  $('form.signup_ajax').on('submit', function(e) {
    e.preventDefault();
    let theForm = $(this),
      url = theForm.attr('action'),
      type = theForm.attr('method');
    let source = $(theForm).find('input[name=source]').val();
    let email = $(theForm).find('input[name=email]').val();
    if (isValidEmail(email)) {
      if (!isBlackListed(email)) {
        $(theForm).find(".error_msg").css("display", "none");
        $.ajax({
          url: form_object.ajax_url,
          type: "POST",
          data: {
            action: 'set_form',
            source: source,
            email: email,
          },
          success: function(response) {
            $(theForm).find(".signup_fields").remove();
            $(theForm).find(".success_msg").css({"color":"#fff", "display": "block"});
            // if (getWithExpiry("ab-link") == "is_A") {
               openTypeForm("NuCyjbco",email);
            // } else {
            //  window.location.href = '/ahana-sign-up';
            // }

          },
          error: function(jqXHR, textStatus, errorThrown) {
            $(theForm).find(".error_msg").html("There was an error (" + textStatus + ") <br>please try again.").css("display", "block");
          }
        });
      } else { // blacklisted
        $(theForm).find(".error_msg").html("Please enter a business email address.").css("display", "block");
      };
    } else { // invalid format
      $(theForm).find(".error_msg").html("Please enter a valid email address.").css("display", "block");
    };
  }); // onsubmit


  // signup "Step 1" email preform validator and handler
  $('form.signup-email-step1').on('submit', function(e) {
    e.preventDefault();
    let theForm = $(this),
      url = theForm.attr('action'),
      type = theForm.attr('method');
    let source = $(theForm).find('input[name=source]').val();
    let email = $(theForm).find('input[name=email]').val();
    if (isValidEmail(email)) {
      if (!isBlackListed(email)) {
        $(theForm).find(".error_msg").css("display", "none");
        $.ajax({
          url: form_object.ajax_url,
          type: "POST",
          data: {
            action: 'set_form',
            source: source,
            email: email,
          },
          success: function(response) {
            // $(theForm).find(".signup_fields").remove();
            // $(theForm).find(".success_msg").css("display", "block");
            openTypeForm("eEyLxwjC",email);
          },
          error: function(jqXHR, textStatus, errorThrown) {
            $(theForm).find(".error_msg").html("There was an error (" + textStatus + ") <br>please try again.").css("display", "block");
          }
        });
      } else { // blacklisted
        $(theForm).find(".error_msg").html("Please enter a business email address.").css("display", "block");
      };
    } else { // invalid format
      $(theForm).find(".error_msg").html("Please enter a valid email address.").css("display", "block");
    };
  }); // onsubmit


  // full signup form validator and handler
  $('form.signup-full').on('submit', function(e) {
    e.preventDefault();
    if( $(this).find('.verify').val().length > 0 ){ 
      return false; 
    }
    let theForm = $(this),
      url = theForm.attr('action'),
      type = theForm.attr('method');
    let first = $(theForm).find('input[name=first]').val();
    let last = $(theForm).find('input[name=last]').val();
    let email = $(theForm).find('input[name=email]').val();
    let company = $(theForm).find('input[name=company]').val();
    let title = $(theForm).find('input[name=title]').val();
    let cloud_service = $('input[name=cloud_service]:checked').map(function(_, el) {
      return $(el).val();
    }).get();
    cloud_service = cloud_service.toString();
    let data_sources = $('input[name=data_sources]:checked').map(function(_, el) {
      return $(el).val();
    }).get();
    data_sources = data_sources.toString();
    let metadata = $('input[name=metadata]:checked').map(function(_, el) {
      return $(el).val();
    }).get();
    metadata = metadata.toString();
    let formstatus = "valid";
    $(theForm).find(".error").css("display", "none");

    console.log(isValidEmail(email));
    // check email format
    if (!isValidEmail(email)) { // invalid format
      formstatus = "error";
      $(theForm).find(".email_error").html("Please enter a valid business email address.").css("display", "block");
    };

    // check email against blacklist
    if (isValidEmail(email) && isBlackListed(email)) { // valid format but is blacklisted
      formstatus = "error";
      $(theForm).find(".email_error").html("Please enter a valid <u>business</u> email address.").css("display", "block");
    };

    // check required checkboxes
    if (cloud_service.length < 1){
      formstatus = "error";
      $(theForm).find(".cloud_svc_error").html("Please select at least one.").css("display", "block");
    }
    // if (data_sources.length < 1){
    //   formstatus = "error";
    //   $(theForm).find(".data_src_error").html("Please select at least one.").css("display", "block");
    // }
    // if (metadata.length < 1){
    //   formstatus = "error";
    //   $(theForm).find(".metadata_error").html("Please select at least one.").css("display", "block");
    // }

    if (formstatus == "valid") {
      $.ajax({
        url: form_object.ajax_url,
        type: "POST",
        data: {
          action: 'set_form',
          first: first,
          last: last,
          email: email,
          company: company,
          title: title,
          cloud_service: cloud_service,
          data_sources: data_sources,
          metadata: metadata
        },
        success: function(response) {
          window.location.href = '/reserve';
        },
        error: function(jqXHR, textStatus, errorThrown) {
          $(theForm).find(".form_error").html("There was an error (" + textStatus + ") <br>please try again.").css("display", "block");
        }
      });
    } else {
      $(theForm).find(".submit_error").html("There were errors or missing required inputs. <br>Please check above.").css("display", "block");
      return false;
    }

  }); // onsubmit



  function isValidEmail(email) { // returns true if format is valid
    const emailFormat = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return emailFormat.test(email);
  }

  function isBlackListed(email) { // returns true if email domain is blacklisted
    const blackList = ["gmail.com", "yahoo.com", "hotmail.com", "aol.com", "hotmail.co.uk", "hotmail.fr", "msn.com", "yahoo.fr", "wanadoo.fr", "orange.fr", "comcast.net", "yahoo.co.uk", "yahoo.com.br", "yahoo.co.in", "live.com", "rediffmail.com", "free.fr", "gmx.de", "web.de", "yandex.ru", "yandex.com", "ymail.com", "libero.it", "outlook.com", "uol.com.br", "bol.com.br", "mail.ru", "cox.net", "hotmail.it", "sbcglobal.net", "sfr.fr", "live.fr", "verizon.net", "live.co.uk", "googlemail.com", "yahoo.es", "ig.com.br", "live.nl", "bigpond.com", "terra.com.br", "yahoo.it", "neuf.fr", "yahoo.de", "alice.it", "rocketmail.com", "att.net", "laposte.net", "facebook.com", "bellsouth.net", "yahoo.in", "hotmail.es", "charter.net", "yahoo.ca", "yahoo.com.au", "rambler.ru", "hotmail.de", "tiscali.it", "shaw.ca", "yahoo.co.jp", "sky.com", "earthlink.net", "optonline.net", "freenet.de", "t-online.de", "aliceadsl.fr", "virgilio.it", "home.nl", "qq.com", "telenet.be", "me.com", "yahoo.com.ar", "tiscali.co.uk", "yahoo.com.mx", "voila.fr", "gmx.net", "mail.com", "planet.nl", "tin.it", "live.it", "ntlworld.com", "arcor.de", "yahoo.co.id", "frontiernet.net", "hetnet.nl", "live.com.au", "yahoo.com.sg", "zonnet.nl", "club-internet.fr", "juno.com", "optusnet.com.au", "blueyonder.co.uk", "bluewin.ch", "skynet.be", "sympatico.ca", "windstream.net", "mac.com", "macmail.com", "centurytel.net", "chello.nl", "live.ca", "aim.com", "bigpond.net.au", "protonmail.com", "163.com", "123.com", "mail2bug.com", "zoho.com", "icloud.com", "tutanota.com", "mhzayt.online", "30gigs.com", "bigstring.com", "bluebottle.com", "emailaccount.com", "fastmail.fm", "hushmail.com", "icqmail.com", "inbox.com", "inmail24.com", "lycos.com", "safe-mail.net"];
    let emailDomain = email.substr(email.search('@') + 1);
    let emailDomainLC = emailDomain.toLowerCase();
    return blackList.indexOf(emailDomainLC) > -1;
  } // blacklist


// ANNOUNCEMENT HANDLER 
    $('.announcement').each( function(){
      var obj = $(this);
      var top_of_obj = $(this).offset().top;
      var check_point = $(window).scrollTop() + ($(window).height())-100;
      if( top_of_obj < check_point ){
        setTimeout(function(){obj.addClass('revealed');},2500)
      }
    })

// BIG ANNOUNCEMENT HANDLER 
    $('.bigannouncement').each( function(){
      var obj = $(this);
      setTimeout(function(){obj.addClass('revealed');},1500)
    })

  $('body').on('click','.bigannouncement .close', function(){
    $('.bigannouncement').removeClass('revealed');
  })

  // REVEAL EFFECT... EACH ITEM CLASS fade-in WILL FADE REVEAL WHEN SCROLLED TO.
  function checkScrollEffects(){
    $('.expand-on-scroll').each( function(){
      var obj = $(this);
      var top_of_obj = $(this).offset().top;
      var check_point = $(window).scrollTop() + ($(window).height())-200;
      if( top_of_obj < check_point ){
        obj.addClass('revealed');
      }
    })
  }

  // WINDOW SCROLL AND LOAD HANDLERS
  $( window ).on('scroll', function() {
    checkScrollEffects();
  });
  $( window ).on('load', function() {
    checkScrollEffects();
  });

  // AWARDS ON ABOUT PAGE REVEAL IN SEQUENCE
  $('.awards .kt-row-column-wrap').each( function(){
        $(this).children().each(function(){
          var obj = $(this);
          var del = $(this).index() * 300;
          setTimeout(function(){
            $(obj).addClass('revealed');
          },del)
        })
    })

}); // jquery doc ready